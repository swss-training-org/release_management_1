name: Production Deployment Request via Tag

on:
  push:
    tags:
      - 'prod-v*'

permissions:
  contents: read
  issues: write
  actions: write
  pull-requests: write

jobs:
  validate-and-plan:
    name: CI Validation & Plan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Lint Check (Fake)
        run: echo "âœ… Linting completed"

      - name: Security Scan (Fake)
        run: echo "âœ… Security scan completed"

      - name: Terraform Plan (Fake)
        run: |
          echo "Simulating Terraform plan..."
          echo "# Terraform Plan Output\nResource to be added: 2\nResource to be modified: 1\nResource to be deleted: 0" > plan_output.txt

      - name: Categorize Changes (Fake)
        run: |
          echo "Categorizing plan..."
          echo "Changes categorized as MINOR (1 modify, 2 add)" > change_summary.txt

      - name: Generate Issue Content from Template
        run: |
          echo "ğŸ“ Filling deployment issue template"
          cat <<EOF > filled_issue.md
          ## ğŸš€ Production Deployment Request

          ### ğŸ“Œ Deployment Tag
          \`${{ github.ref_name }}\`

          ### ğŸ“‹ Terraform Plan Output
          \`\`\`
          $(cat plan_output.txt)
          \`\`\`

          ### ğŸ§  Change Categorization
          \`\`\`
          $(cat change_summary.txt)
          \`\`\`

          ### ğŸ§¾ Notes
            - Please review the changes and approve or reject this deployment.
            - Deployment will proceed only after manual approval.
          EOF

      - name: Create GitHub Issue for Approval
        uses: peter-evans/create-issue-from-file@v4
        with:
          title: "ğŸš€ Deployment Request for Production - ${{ github.ref_name }}"
          content-filepath: filled_issue.md
          labels: "deployment-request, pending-approval"
          assignees: yaoswisscom
        

  apply-on-approval:
    name: Apply to Production
    if: github.event.issue.title == 'ğŸš€ Deployment Request for Production - ${{ github.ref_name }}'
    runs-on: ubuntu-latest
    needs: validate-and-plan
    environment:
      name: production
      #url: https://prod.example.com

    steps:
      - name: Await Manual Approval
        run: echo "â³ Awaiting manual approval via GitHub Environments..."

      - name: Terraform Apply (Fake)
        run: echo "âœ… Terraform Apply simulated"

      - name: Post-Deployment Success Comment
        uses: actions/github-script@v7
        with:
          script: |
            github.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: "âœ… Production deployment for tag `${{ github.ref_name }}` completed successfully."
            });
